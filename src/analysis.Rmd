---
title: "ANES media bias"
author: "Tyler Garner"
date: "2022-12-29"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Research Questions

1. Do responses to questions on empathy and family politics vary by party affiliation?
2. Are responses to questions on empathy and family politics associated with bias and reliability of media outlets?
3. Is there a relationship between reponses to questions on empathy and family politics with social media usage?

4. Do more biased media consumers vote in caucuses more often?

```{r load-libs-and-data}
library(MASS) # Load MASS first so dplyr::select() does not get masked
library(tidyverse)

anes <- read_csv("data/raw/anes_timeseries_2020_csv_20220210.csv",
                 show_col_types = FALSE)
```

```{r}
dim(anes)
head(anes)
```

Create subsets of the ANES data set for the variables of interest.

```{r}
# Pre- (a) and post-election (b) weights
anes_weights <- anes %>%
  select(V200010a:V200010b)

# Party affiliation, registration, and voting
anes_registration <- anes %>%
  select(V201018:V201021)

# Family and empathy responses
anes_empathy <- anes %>%
  select(V202451:V202456)

# Pre-election media responses
anes_media <- anes %>%
  select(V201629a:V201637x)

# Post-election social media responses
anes_social_media <- anes %>%
  select(V202541a:V202547) # Note there are post-election
```

## Impute non-respondants

Select all of the pre-election survey columns to use for bagged tree imputing.  Remove variables with zero variance (have only 1 value).  Relabel media variables that are identified as 'Refused' or 'Interview breakoff' to NA (missing values) to be relabled later by bagged tree imputing.

```{r}
anes_to_impute <- anes %>%
  select(V201001:V201658p) # all pre-election survey vars

# Remove vars with zero variance
non_zero_vars <- sapply(anes_to_impute, function(x) length(unique(x))) %>%
  as.data.frame() %>%
  filter(. > 1) %>%
  rownames()

anes_to_impute <- anes_to_impute %>%
  select(all_of(non_zero_vars))

# In media vars convert -9 (Refused) and -5 (Interview breakoff (sufficient partial IW)) to NA
anes_to_impute <- anes_to_impute %>%
  mutate(across(V201629a:V201636k, ~ ifelse(. < -1, NA, .)))
```

Implement the bagged tree imputation from the `caret` library to fill in missing values based on the pre-election data.

```{r}
# Use bagged tree imputation to fill in missing values
library(caret)
library(doParallel)

n_cores <- parallel::detectCores()
cl <- makeForkCluster(n_cores)
registerDoParallel(cl)

anes9 <- anes_to_impute %>%
  select(V201629a:V201636k)

set.seed(4960)
preProcValues <- preProcess(anes9,
                            "bagImpute",
                            k = 20,
                            knnSummary = median,
                            verbose = TRUE)

anes_imputed <- predict(preProcValues,
                            anes9,
                            verbose = TRUE)
                            # na.action = na.pass)

stopCluster(cl)

# Check that there are no NA values
sum(is.na(anes_imputed))

saveRDS(anes_imputed, 'data/interim/imputed-media-vars.RDS')
```



```{r}
anes_imputed <- readRDS('data/interim/imputed-media-vars.RDS')
```

Bring in the Ad Fontes data and print out basic EDA

```{r}
adfontes <- read_csv('data/raw/adfontes.csv') %>%
  mutate(Media = factor(Media))

adfontes %>%
  group_by(Media) %>%
  summarize(mean_rel = mean(Reliability, na.rm = TRUE),
            mean_bias = mean(Bias, na.rm = TRUE))

hist(adfontes$Bias, breaks = 10)
hist(adfontes$Reliability, breaks = 10)

ggplot(adfontes,
       aes(x = Bias,
           y = Reliability,
           color = Media)) +
  geom_point(alpha = 0.5) +
  theme_bw() +
  theme(legend.position = 'bottom')

# Linear model of Bias vs Reliability
bias_vs_rel <- lm(Reliability ~ abs(Bias),
                  data = adfontes)

summary(bias_vs_rel)
```



```{r}
# Keep only the media vars that have Reliability and Bias scores
media_codes <- adfontes %>%
  drop_na() %>%
  pull(Code)
  
anes_imputed_media <- anes_imputed %>%
  select(all_of(media_codes))

# Convert all -1 to 0
anes_imputed_media <- anes_imputed_media %>%
  mutate(across(everything(), ~ replace(., . == -1, 0)))

# Multiply col-wise to get the Bias and Reliability within each column
anes_imputed_media_bias <- anes_imputed_media *
  adfontes$Bias[match(names(anes_imputed_media),
                      adfontes$Code)][col(anes_imputed_media)]
anes_imputed_media_rel <- anes_imputed_media *
  adfontes$Reliability[match(names(anes_imputed_media),
                             adfontes$Code)][col(anes_imputed_media)]

anes_imputed_media$Total_Bias <- rowSums(anes_imputed_media_bias)
anes_imputed_media$Total_Rel <- rowSums(anes_imputed_media_rel)

# Get the average Bias and Reliability based on the media consumed for each respondant
# This will create NaN values for respondents with all 0 values
anes_imputed_media$Avg_Bias <- anes_imputed_media$Total_Bias / rowSums(anes_imputed_media_bias != 0)
anes_imputed_media$Avg_Rel <- anes_imputed_media$Total_Rel / rowSums(anes_imputed_media_rel != 0)

anes_imputed_media$Median_Bias <- apply(anes_imputed_media_bias, 1, function(x) median(x[x !=0]))
anes_imputed_media$Median_Rel <- apply(anes_imputed_media_rel, 1, function(x) median(x[x != 0]))

# Replace NaN values with 0
anes_imputed_media <- anes_imputed_media %>%
  mutate(across(c(Avg_Bias, Avg_Rel), ~ replace(., is.nan(.), 0)),
         across(c(Median_Bias, Median_Rel), ~ replace(., is.na(.), 0)))


hist(anes_imputed_media$Avg_Bias, breaks = 20)
hist(anes_imputed_media$Avg_Rel, breaks = 20)
hist(anes_imputed_media$Median_Bias, breaks = 20)
hist(anes_imputed_media$Median_Rel, breaks = 20)
```

```{r}
# Bind the weights, party affiliation, and empathy var columns
anes_bias_rel <- anes_registration %>%
  bind_cols(anes_weights, anes_empathy)

# Plot the total number of respondents in each political affiliation
anes_bias_rel %>%
  select(V201018) %>%
  group_by(V201018) %>%
  summarize(n = n()) %>%
  ggplot(aes(x = ordered(V201018),
             y = n)) +
    geom_col() +
    scale_x_discrete(labels = c('Refused', 'Dont Know', 'Inapplicable', 'D', 'R', 'I', 'Other'))
```

Create a data frame in long format for plotting the weights, empathy, party affiliation, and bias/reliability variables.

```{r}
anes_plt_df <- anes_bias_rel %>%
  select(V200010a, V201018, V202451:V202455, Avg_Bias:last_col()) %>%
  pivot_longer(V202451:V202455,
               names_to = 'empathy',
               values_to = 'value') %>%
  filter(value > 0) %>%
  mutate(value = ordered(value))

# Plot Reliability vs Bias for political party affiliation
anes_plt_df %>%
  select(!c(empathy, value)) %>%
  distinct() %>%
  filter(V201018 >= -1) %>%
  ggplot(aes(x = Median_Bias,
             y = Median_Rel,
             color = ordered(V201018))) +
  geom_point(alpha = 0.25)

# Do the same plot but with only R, D, and I and recolored
anes_plt_df %>%
  select(!c(empathy, value)) %>%
  distinct() %>%
  filter(V201018 %in% c(1, 2, 4)) %>%
  ggplot(aes(x = Median_Bias,
             y = Median_Rel,
             color = ordered(V201018))) +
  geom_point(alpha = 0.25) +
  scale_color_manual(values = c('blue', 'red', 'grey10'))

# Plot Reliability vs Bias for each of the fampol and empathy
anes_plt_df %>%
  ggplot(aes(x = Median_Bias,
             y = Median_Rel,
             color = value)) +
  geom_point(alpha = 0.5) +
  facet_wrap(~ empathy)
```

```{r}
library(rstatix)

# Kruskal-Wallis test to see if repsondants vary on empathy based on political party
anes_plt_df %>%
  filter(V201018 %in% c(1, 2, 4)) %>%
  group_by(empathy) %>%
  kruskal_test(value ~ V201018) %>%
  adjust_pvalue()

anes_plt_df %>%
  filter(V201018 %in% c(1, 2, 4)) %>%
  group_by(V201018, empathy, value) %>%
  summarize(n = n()) %>%
  ggplot(aes(x = ordered(V201018),
             y = n,
             fill = value)) +
    geom_col(position = 'fill') +
    facet_wrap(~ empathy)
  
```




```{r}
fit <- anes_plt_df %>%
  filter(empathy == 'V202451') %>%
  polr(formula = value ~ abs(Median_Bias) * Median_Rel,
       weights = V200010a,
       Hess = TRUE)
  
summary(fit)

## Get table of coefficients
coef_table <- coef(summary(fit))

## Estimate and print p-values
p <- pnorm(abs(coef_table[, "t value"]), lower.tail = FALSE) * 2

coef_table <- cbind(coef_table, "p value" = round(p, 4))

coef_table
```

